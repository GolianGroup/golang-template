version: "3.9"

services:
  app:
    build:
      context: ../../
      dockerfile: ./build/dockerfiles/Dockerfile
    container_name: template-app
    restart: always
    volumes:
      - ../../config/config.dev.yml:/app/config/config.yml
    ports:
      - "8080:8080"
    # environment:
    #   - MODE=development
    depends_on:
      - postgres
      - arango
      - redis
      - clickhouse
    networks:
      - backend

  postgres:
    image: postgres:latest
    container_name: template-postgres
    restart: always
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: ${DB_NAME:-myapp}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-1234}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - backend

  arango:
    image: arangodb:latest # NOTE: test in version 3.12.x, other version may have some compatibility issues
    container_name: template-arango
    restart: always
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGO_PASSWORD:-rootpassword}
    volumes:
      - arango_data:/var/lib/arangodb3
    ports:
      - "8529:8529"
    networks:
      - backend

  redis:
    image: redis:latest
    container_name: template-redis
    restart: always
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-""}
      REDIS_DATABASES: 1
      REDIS_PORT: 6379
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/var/lib/redis/data/
    networks:
      - backend


  clickhouse:
    image: 'clickhouse/clickhouse-server:${CHVER:-latest}'
    user: '101:101'
    container_name: clickhouse
    hostname: clickhouse
    volumes:
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml
      - ${PWD}/fs/volumes/clickhouse/etc/clickhouse-server/users.d/users.xml:/etc/clickhouse-server/users.d/users.xml
    ports:
      - '127.0.0.1:8123:8123'
      - '127.0.0.1:9000:9000'
    depends_on:
      - clickhouse-keeper
  clickhouse-keeper:
    image: 'clickhouse/clickhouse-keeper:${CHKVER:-latest-alpine}'
    user: '101:101'
    container_name: clickhouse-keeper
    hostname: clickhouse-keeper
    volumes:
      - ${PWD}/fs/volumes/clickhouse-keeper/etc/clickhouse-keeper/:/etc/clickhouse-keeper/
    ports:
      - '127.0.0.1:9181:9181'

  
networks:
  backend:
    driver: bridge


volumes:
  postgres_data:
  arango_data:
  clickhouse_data:
  redis_data:
